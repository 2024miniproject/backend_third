<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒë§¤</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='detail.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='bar.css') }}">
    <style>
        /* êµ¬ë§¤ ì‹ ì²­ ì™„ë£Œ ì‹œ ë²„íŠ¼ ìƒ‰ì„ íšŒìƒ‰ìœ¼ë¡œ ë°”ê¾¸ëŠ” ìŠ¤íƒ€ì¼ */
        .buy.clicked {
            background-color: gray;
            color: white;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar">
        <div class="logo">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo">
            <button class="plus-button" onclick="location.href='write.html'">+</button>
        </div>
        <ul class="menu">
            <li><a href="#"><span class="icon" onclick="location.href='/home'">ğŸ </span> Home</a></li>
            <li><a href="#"><span class="icon" onclick="location.href='/mydeal_views/mydealbuy'">ğŸ“¦</span> My deal</a></li>
            <li><a href="#"><span class="icon" onclick="location.href='/information'">â„¹ï¸</span> Info</a></li>
        </ul>
    </div>

    <div class="imagebox">
        {% if post.image_filename %}
            <img src="{{ url_for('static', filename=post.image_filename) }}" alt="Uploaded Image" style="max-width: 100%; height: auto;">
        {% endif %}
    </div>

    <div class="seller">
        <img class="profilepic" src="X.jpeg">
        <img class="sellm" src="X.jpeg">
    </div>
    <div class="sellname">
        <h3>ìµëª…ì˜ ë½€ì‚</h3>
        <p>ìµœê·¼ ë‹µì¥ - n ì‹œê°„ ì „</p>
    </div>
    <div class="boxxx">
        <h2>{{ post.title }}</h2> <!-- ê²Œì‹œê¸€ ì œëª© -->
        <p>ê°€ê²©: {{ post.price }}ì›</p> <!-- ê²Œì‹œê¸€ ê°€ê²© -->
        <div class="divide"></div>
        <div class="sellingpost">
            <p>{{ post.content }}</p> <!-- ê²Œì‹œê¸€ ë‚´ìš© -->
        </div>

        <!-- êµ¬ë§¤ ì‹ ì²­í•˜ê¸° ë²„íŠ¼ -->
        <button class="buy" onclick="submit_Purchase()">êµ¬ë§¤ ì‹ ì²­í•˜ê¸°</button>

        <hr>

        <h5>ë‹µë³€</h5>
        <div class="answer-box">
            {% for answer in answers %}
                <div class="answercomment">
                    <p>{{ answer.content }}</p>
                    <small>ì‘ì„±ì: {{ answer.user.username }}</small> <!-- ì‘ì„±ì ì´ë¦„ í‘œì‹œ -->
                </div>
            {% else %}
                <p>ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endfor %}
        </div>

        <hr>

        <h5>ëŒ“ê¸€</h5>
        <div class="comment-box" id="commentBox">
            <!-- ëŒ“ê¸€ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤. -->
            {% for comment in comments %}
                <div class="commentcomment">
                    <img src="X.jpeg" class="commentpic">
                    <div class="text-wrapper">
                        <h3>{{ comment.username }}</h3> <!-- ëŒ“ê¸€ ì‘ì„±ì ì´ë¦„ -->
                        <p>{{ comment.content }}</p> <!-- ëŒ“ê¸€ ë‚´ìš© -->
                        <small>ì‘ì„±ì¼: {{ comment.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</small> <!-- ì‘ì„±ì¼ í‘œì‹œ -->
                    </div>
                </div>
            {% else %}
                <p>ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endfor %}
        </div>
    </div>

    <div>
        <textarea class="commentwrite" id="commentInput" placeholder="ëŒ“ê¸€ì„ ì¶”ê°€í•´ë³´ì„¸ìš”."></textarea>
        <button class="writebutton" onclick="submitComment()">ëŒ“ê¸€ ë‹¬ê¸°</button>
    </div>

    <script>
        function submitPurchase() {
            // ë²„íŠ¼ì„ í´ë¦­í•œ ìƒíƒœë¡œ ë°”ê¾¸ê¸° (íšŒìƒ‰ìœ¼ë¡œ ë³€ê²½)
            var button = document.querySelector('.buy');
            button.classList.add('clicked');
            button.textContent = 'êµ¬ë§¤ ì‹ ì²­ ì™„ë£Œ';

            // íŒì—… ë©”ì‹œì§€ ë„ìš°ê¸°
            alert("êµ¬ë§¤ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. nì¼ê¹Œì§€ 0000-0000 ê³„ì¢Œë¡œ ì…ê¸ˆ ë°”ëë‹ˆë‹¤.");

            // í˜„ì¬ ê²Œì‹œê¸€ì˜ ID ê°€ì ¸ì˜¤ê¸°
            var postId = {{ post.id }};

            // AJAX ìš”ì²­ì„ í†µí•´ ìƒí’ˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            fetch('/submit_purchase', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ post_id: postId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // mydealsell.htmlì˜ div.contentì— ì¶”ê°€
                    const contentDiv = document.querySelector('.content'); // mydealsell.htmlì˜ div.content ì„ íƒ
                    contentDiv.innerHTML += `
                        <div class="product-info">
                            <h4>${data.data.title}</h4>
                            <p>${data.data.content}</p>
                            <p>ê°€ê²©: ${data.data.price}ì›</p>
                        </div>
                    `;
                    // mydealsell.htmlë¡œ ì´ë™
                    window.location.href = '/mydeal_views/mydealsell';
                } else {
                    alert(data.message);
                }
            });
        }


        function submitComment() {
            var commentText = document.getElementById('commentInput').value.trim();
            var questionId = {{ post.id }};  // í˜„ì¬ ê²Œì‹œê¸€ì˜ IDë¥¼ ê°€ì ¸ì˜´
            if (commentText) {
                fetch('/add_comment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ comment: commentText, question_id: questionId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('commentInput').value = '';
                        fetchComments();
                    } else {
                        alert("ëŒ“ê¸€ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                });
            } else {
                alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
            }
        }


        function fetchComments() {
            var questionId = {{ post.id }};  // í˜„ì¬ ê²Œì‹œê¸€ì˜ IDë¥¼ ê°€ì ¸ì˜´
            fetch(`/get_comments/${questionId}`)
                .then(response => response.json())
                .then(comments => {
                    var commentBox = document.getElementById('commentBox');
                    commentBox.innerHTML = '';
                    comments.forEach(comment => {
                        var newComment = document.createElement('div');
                        newComment.className = 'commentcomment';
                        newComment.innerHTML = `
                            <img src="X.jpeg" class="commentpic">
                            <div class="text-wrapper">
                                <h3>${comment.username}</h3>
                                <p>${comment.content}</p>
                                <small>ì‘ì„±ì¼: ${new Date(comment.created_at).toLocaleString()}</small>
                            </div>
                        `;
                        commentBox.appendChild(newComment);
                    });
                });
        }


        // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ ëŒ“ê¸€ì„ ê°€ì ¸ì˜´
        window.onload = fetchComments;
    </script>
</body>
</html>
